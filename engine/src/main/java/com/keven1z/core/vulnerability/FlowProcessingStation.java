package com.keven1z.core.vulnerability;

import com.keven1z.core.hook.http.request.AbstractRequest;
import com.keven1z.core.hook.http.response.HttpServletResponse;
import com.keven1z.core.log.LogTool;
import com.keven1z.core.model.ApplicationModel;
import com.keven1z.core.pojo.*;
import com.keven1z.core.vulnerability.detectors.*;
import org.apache.log4j.Logger;

import java.util.ArrayList;
import java.util.List;

import static com.keven1z.core.hook.HookThreadLocal.*;

/**
 * @author keven1z
 * @date 2023/10/29
 * hook以及流量处理类
 */
public class FlowProcessingStation {
    private static final List<Detector> detectors = new ArrayList<>();
    private static final Logger logger = Logger.getLogger(FlowProcessingStation.class);

    static {
        detectors.add(new SSRFDetector());
        detectors.add(new SqliDetector());
        detectors.add(new XxeDetector());
        detectors.add(new CmdiDetector());
        detectors.add(new DeserializationDetector());
        detectors.add(new UrlRedirectDetector());
        detectors.add(new XSSDetector());
        detectors.add(new PathTraversalDetector());
        detectors.add(new FileUploadDetector());
        detectors.add(new SpelDetector());
        detectors.add(new XpathDetector());
    }

    private FlowProcessingStation() {
    }

    public static FlowProcessingStation getInstance() {
        return Inner.flowProcessingStation;
    }

    private static class Inner {
        private static final FlowProcessingStation flowProcessingStation = new FlowProcessingStation();
    }

    public void processAndReportFindings() {

        if (SINGLE_FINDING_THREADLOCAL.get() == null || TAINT_GRAPH_THREAD_LOCAL.get() == null) {
            logger.error("ThreadLocal data is null.");
            return;
        }

        if (SINGLE_FINDING_THREADLOCAL.get().isEmpty() && TAINT_GRAPH_THREAD_LOCAL.get().getSinkNodes().isEmpty()) {
            if (LogTool.isDebugEnabled()) {
                logger.info("Not found any sink node,url:" + REQUEST_THREAD_LOCAL.get().getRequest().getRequestURL());
            }
            return;
        }

        List<FindingData> findingDataList = new ArrayList<>(SINGLE_FINDING_THREADLOCAL.get());

        FindingReportBo findingReportBo = prepareFindingReport(findingDataList);
        boolean isOffer = FINDING_REPORT_QUEUE.offer(findingReportBo);
        if (!isOffer) {
            logger.warn("Finding report queue is full. Report was not added.");
        }
    }
    /**
     * 准备发现漏洞报告业务对象
     *
     * @param findingDataList 发现的数据列表
     * @return 包含请求数据、响应数据、单个发现数据列表和污染图的 {@link FindingReportBo} 对象
     */
    private FindingReportBo prepareFindingReport(List<FindingData> findingDataList) {
        FindingReportBo findingReportBo = new FindingReportBo(ApplicationModel.getAgentId());
        findingReportBo.setRequestData(buildRequest());
        findingReportBo.setResponseData(buildResponse());
        findingReportBo.setSingleFindingDataList(findingDataList);
        findingReportBo.setTaintGraph(TAINT_GRAPH_THREAD_LOCAL.get());
        return findingReportBo;
    }

    public Detector getDetector(String vulnType) {
        for (Detector detector : detectors) {
            if (detector.supportType(vulnType)) {
                return detector;
            }
        }
        return null;
    }

    /**
     * 构建http请求
     */
    private HttpRequestData buildRequest() {
        AbstractRequest request = REQUEST_THREAD_LOCAL.get().getRequest();
        HttpRequestData httpRequestData = new HttpRequestData(request.getRequestURLString(), request.getMethod(), request.getHeaders());
        httpRequestData.setRequestBody(request.getStringBody());
        httpRequestData.setUri(request.getRequestURI());
        httpRequestData.setProtocol(request.getProtocol());
        return httpRequestData;
    }

    private HttpResponseData buildResponse() {
        HttpServletResponse response = REQUEST_THREAD_LOCAL.get().getResponse();
        HttpResponseData httpResponseData = new HttpResponseData(response.getHeaders());
        httpResponseData.setStatusCode(response.getStatusCode());
        return httpResponseData;
    }
}
