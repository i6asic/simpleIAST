package com.keven1z.core.vulnerability.detectors;

import com.keven1z.core.consts.VulnerabilityLevel;
import com.keven1z.core.consts.VulnerabilityType;
import com.keven1z.core.log.LogTool;
import com.keven1z.core.model.graph.TaintData;
import com.keven1z.core.utils.CommonUtils;
import com.keven1z.core.utils.TaintUtils;
import com.keven1z.core.vulnerability.AbstractDetector;
import com.keven1z.core.vulnerability.DetectContext;
import org.apache.log4j.Logger;
import java.util.LinkedList;
import java.util.List;

/**
 * URl跳转漏洞检测规则
 */
public class UrlRedirectDetector extends AbstractDetector {
    private static final Logger logger = Logger.getLogger(UrlRedirectDetector.class);

    public UrlRedirectDetector() {
        super(VulnerabilityType.URL_REDIRECT, VulnerabilityLevel.MIDDLE);
    }

    @Override
    public boolean detect(DetectContext context) {
        LinkedList<TaintData> flowLinks = context.getFlowLinks();
        List<Object> sourceList = TaintUtils.calculateSourceValue(flowLinks);
        if (sourceList.isEmpty()) {
            return false;
        }
        boolean isSatisfied = false;
        for (Object source : sourceList) {
            if (source instanceof String && CommonUtils.isURL(source.toString())) {
                isSatisfied = true;
            }
        }
        if (!isSatisfied){
            if (LogTool.isDebugEnabled()) {
                logger.warn("[Url Redirect] Source is not URL.");
            }
        }

        String taintValue = flowLinks.getLast().getFromValue();
        return CommonUtils.isURL(taintValue);
    }
}
